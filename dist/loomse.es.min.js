import{el as e,setStyle as t,mount as s,unmount as i}from"redom";var n={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};class r{constructor({firstScene:e,scenes:t,author:s,shortName:i,longName:n,description:r,language:o}){this.firstScene=e,this.scenes=t,this.shortName=i,this.longName=n,this.author=s,this.description=r,this.language=o}}var o,a={width:"100%",height:"100%"};!function(e){e.START="start",e.STOP="stop"}(o||(o={}));class h{constructor(e){this.index=0,this.events=e,this.queue=this.build(),this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const s={id:t,time:this.events[t].in,action:o.START},i={id:t,time:this.events[t].out,action:o.STOP};e.push(s,i)}return e}sort(e){if("desc"===e)this.queue.sort(((e,t)=>t.time-e.time));else this.queue.sort(((e,t)=>e.time-t.time))}}function c(e,t){let s=t-e;return void 0===e&&(e=0),s<=0&&(s=t,e=0),Math.floor(Math.random()*s)+e}class d{constructor(){this.registry={}}static tokenGenerator(e){const t=[];for(let s=0;s<e;s+=1){let e;do{e=c(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}broadcast(e,t){this.registry[e]?Object.values(this.registry[e]).forEach((e=>{e.handler.call(e.context,t)})):console.warn("Channel not registered:",e)}unRegister(e){const t=Object.keys(this.registry).filter((t=>Object.keys(this.registry[t]).includes(e)))[0];t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Unregister token not found")}register(e,t,s){const i=d.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][i]={handler:t,context:s},i}}const u=new d;var l,E;!function(e){e.PLAY="director:play",e.PAUSE="director:pause",e.SCENE_CHANGE="director:scenechange",e.SCENE_EVENT="director:sceneevent"}(l||(l={})),function(e){e.ENDED="video:ended",e.DURATION_CHANGED="video:durationchange",e.PAUSED="video:paused",e.PLAYING="video:playing",e.SEEKED="video:seeked",e.SEEKING="video:seeking",e.TIMEUPDATE="video:timeupdate"}(E||(E={}));class g extends Error{}class v{constructor({events:e,startEventCallback:t,stopEventCallback:s}){this.queue=new h(e),this.startEventCallback=t,this.stopEventCallback=s,this.radioUnregisterTokenTimeUpdate=u.register(E.TIMEUPDATE,this.isReadyToAction,this)}unRegister(){u.unRegister(this.radioUnregisterTokenTimeUpdate)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new g("Event data not found");switch(e.action){case o.START:this.startEventCallback(t);break;case o.STOP:this.stopEventCallback(t);break;default:return}this.queue.advance()}}class p{constructor(e){var t;this.events=(t={events:e,startEventCallback:this.start,stopEventCallback:this.stop},new v(t))}start({group:e,payload:t}){u.broadcast(l.SCENE_EVENT,{group:e,action:o.START,payload:t})}stop({group:e,payload:t}){u.broadcast(l.SCENE_EVENT,{group:e,action:o.STOP,payload:t})}unRegister(){this.events.unRegister()}}var T={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const b={height:"5px",width:"0px","background-color":"yellow"};class m{constructor(){this.el=e(".progressCounter",{style:Object.assign({},b)})}update(e=0,s){const i=e/s*100;t(this.el,{width:`${i}%`})}}class y{constructor(){this.duration=999,this.el=e("div",{style:Object.assign({},T)},this.progressCounter=new m),this.radioUnregisterTokenDurationChanged=u.register(E.DURATION_CHANGED,(e=>{this.duration=e})),this.radioUnregisterTokenTimeUpdate=u.register(E.TIMEUPDATE,this.updateProgress,this)}onunmount(){this.stopListeningToRadio()}stopListeningToRadio(){u.unRegister(this.radioUnregisterTokenDurationChanged),u.unRegister(this.radioUnregisterTokenTimeUpdate)}updateProgress(e){this.progressCounter.update(e,this.duration)}}var S,k;!function(e){e.MP4="mp4",e.OGG="ogg",e.WEBM="webm"}(S||(S={})),function(e){e.MP4="video/mp4",e.OGG="video/ogg",e.WEBM="video/webm"}(k||(k={}));class P extends Error{}class f{constructor(t,s){this.el=e("source",{src:s,type:this.mapFileExtensionToMIME_Type(t)})}mapFileExtensionToMIME_Type(e){switch(e){case S.MP4:return k.MP4;case S.OGG:return k.OGG;case S.WEBM:return k.WEBM;default:throw new P("Unable to process source in Video file")}}}var w={width:"100%",height:"100%","object-fit":"contain"};class N extends Error{}class U{constructor({controls:t=!1,loop:s=!1,muted:i=!1,sources:n}){this.el=e("video",{autoplay:!1,controls:t,loop:s,muted:i,style:Object.assign({},w)}),this.sources=this.setSources(n),this.mountSources(),this.broadcastEndedEvent=()=>u.broadcast(E.ENDED),this.broadcastDurationChangeEvent=()=>u.broadcast(E.DURATION_CHANGED,this.el.duration),this.broadcastPlayingEvent=()=>u.broadcast(E.PLAYING,this.el.currentTime),this.broadcastPausedEvent=()=>u.broadcast(E.PAUSED),this.broadcastSeekedEvent=()=>u.broadcast(E.SEEKED,this.el.currentTime),this.broadcastSeekingEvent=()=>u.broadcast(E.SEEKING,this.el.currentTime),this.broadcastTimeUpdateEvent=()=>u.broadcast(E.TIMEUPDATE,this.el.currentTime),this.radioUnregisterTokenPause=u.register(l.PAUSE,this.pause,this),this.radioUnregisterTokenPlay=u.register(l.PLAY,this.play,this),this.listenToVideoEvents()}onunmount(){this.stopListeningToVideoEvents(),this.stopListeningToRadio()}setSources(e){if(!e)throw new N("No video sources found");const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=new f(s,e[s]));return t}mountSources(){for(const e in this.sources){if(!this.sources.hasOwnProperty(e))continue;const t=this.sources[e];s(this.el,t.el)}}listenToVideoEvents(){this.el.addEventListener("ended",this.broadcastEndedEvent),this.el.addEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.addEventListener("paused",this.broadcastPausedEvent),this.el.addEventListener("playing",this.broadcastPlayingEvent),this.el.addEventListener("seeked",this.broadcastSeekedEvent),this.el.addEventListener("seeking",this.broadcastSeekingEvent),this.el.addEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToVideoEvents(){this.el.removeEventListener("ended",this.broadcastEndedEvent),this.el.removeEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.removeEventListener("paused",this.broadcastPausedEvent),this.el.removeEventListener("playing",this.broadcastPlayingEvent),this.el.removeEventListener("seeked",this.broadcastSeekedEvent),this.el.removeEventListener("seeking",this.broadcastSeekingEvent),this.el.removeEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToRadio(){u.unRegister(this.radioUnregisterTokenPause),u.unRegister(this.radioUnregisterTokenPlay)}play(){this.el.play().then((()=>{})).catch((()=>{}))}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}}class A{constructor(t,{events:s,longName:i,video:n}){u.broadcast(l.SCENE_CHANGE,t),this.el=e("div",{style:Object.assign({},a)},this.timeline=new y,this.video=new U(n)),this.sceneId=t,this.events=new p(s),this.longName=i,this.video.play()}onunmount(){this.events.unRegister()}}const C=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){u.register(E.DURATION_CHANGED,(e=>{this.currentDuration=e})),u.register(E.TIMEUPDATE,(e=>{this.currentTime=e}))}},D="0.7.3";class L{constructor(t,{width:i="100%",height:r="100%"}){this.version=D,this.v=D,this.story=null,this.scene=null,this.el=e("div",{style:Object.assign(Object.assign({},n),{width:`${i}`,height:`${r}`})}),s(t,this.el),this.setupSyntheticEvents()}setupSyntheticEvents(){u.register(l.SCENE_EVENT,(e=>{this.el.dispatchEvent(new CustomEvent(l.SCENE_EVENT,{detail:e}))}),this)}setStory(e){this.story=new r(e)}loadScene(e){this.story&&(this.scene&&i(this.el,this.scene),this.scene=new A(e,this.story.scenes[e]),s(this.el,this.scene))}currentDuration(){return C.currentDuration}currentTime(){return C.currentTime}startScript(e){try{return this.setStory(e),this.loadScene(e.firstScene),Promise.resolve()}catch(e){return Promise.reject(`Unable to load story object, ${e}`)}}pause(){u.broadcast(l.PAUSE)}play(){u.broadcast(l.PLAY)}reloadScene(){var e,t;(null===(e=this.scene)||void 0===e?void 0:e.sceneId)&&this.loadScene(null===(t=this.scene)||void 0===t?void 0:t.sceneId)}resize(e,s){t(this.el,{width:`${e}`,height:`${s}`})}skipTo(e){this.loadScene(e)}}export{L as default};
