!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).LoomSE=t()}(this,(function(){"use strict";function e(e,s,i){var n=s.__redom_lifecycle;if(t(n))s.__redom_lifecycle={};else{var o=i;for(s.__redom_mounted&&r(s,"onunmount");o;){var a=o.__redom_lifecycle||{};for(var c in n)a[c]&&(a[c]-=n[c]);t(a)&&(o.__redom_lifecycle=null),o=o.parentNode}}}function t(e){if(null==e)return!0;for(var t in e)if(e[t])return!1;return!0}var s=["onmount","onremount","onunmount"],i="undefined"!=typeof window&&"ShadowRoot"in window;function n(t,n,o,a){var c=v(t),d=v(n);n===d&&d.__redom_view&&(n=d.__redom_view),n!==d&&(d.__redom_view=n);var u=d.__redom_mounted,l=d.parentNode;if(u&&l!==c&&e(0,d,l),null!=o)if(a){var h=v(o);h.__redom_mounted&&r(h,"onunmount"),c.replaceChild(d,h)}else c.insertBefore(d,v(o));else c.appendChild(d);return function(e,t,n,o){for(var a=t.__redom_lifecycle||(t.__redom_lifecycle={}),c=n===o,d=!1,u=0,l=s;u<l.length;u+=1){var h=l[u];c||e!==t&&h in e&&(a[h]=(a[h]||0)+1),a[h]&&(d=!0)}if(!d)return void(t.__redom_lifecycle={});var v=n,g=!1;(c||v&&v.__redom_mounted)&&(r(t,c?"onremount":"onmount"),g=!0);for(;v;){var E=v.parentNode,f=v.__redom_lifecycle||(v.__redom_lifecycle={});for(var p in a)f[p]=(f[p]||0)+a[p];if(g)break;(v.nodeType===Node.DOCUMENT_NODE||i&&v instanceof ShadowRoot||E&&E.__redom_mounted)&&(r(v,c?"onremount":"onmount"),g=!0),v=E}}(n,d,c,l),n}function r(e,t){"onmount"===t||"onremount"===t?e.__redom_mounted=!0:"onunmount"===t&&(e.__redom_mounted=!1);var s=e.__redom_lifecycle;if(s){var i=e.__redom_view,n=0;for(var o in i&&i[t]&&i[t](),s)o&&n++;if(n)for(var a=e.firstChild;a;){var c=a.nextSibling;r(a,t),a=c}}}function o(e,t,s){var i=v(e);if("object"==typeof t)for(var n in t)a(i,n,t[n]);else a(i,t,s)}function a(e,t,s){e.style[t]=null==s?"":s}var c="http://www.w3.org/1999/xlink";function d(e,t,s,i){var n=v(e);if("object"==typeof t)for(var r in t)d(n,r,t[r],i);else{var a=n instanceof SVGElement,c="function"==typeof s;if("style"===t&&"object"==typeof s)o(n,s);else if(a&&c)n[t]=s;else if("dataset"===t)l(n,s);else if(a||!(t in n)&&!c||"list"===t){if(a&&"xlink"===t)return void u(n,s);i&&"class"===t&&(s=n.className+" "+s),null==s?n.removeAttribute(t):n.setAttribute(t,s)}else n[t]=s}}function u(e,t,s){if("object"==typeof t)for(var i in t)u(e,i,t[i]);else null!=s?e.setAttributeNS(c,t,s):e.removeAttributeNS(c,t,s)}function l(e,t,s){if("object"==typeof t)for(var i in t)l(e,i,t[i]);else null!=s?e.dataset[t]=s:delete e.dataset[t]}function h(e,t,s){for(var i=0,r=t;i<r.length;i+=1){var o=r[i];if(0===o||o){var a=typeof o;"function"===a?o(e):"string"===a||"number"===a?e.appendChild((c=o,document.createTextNode(null!=c?c:""))):g(v(o))?n(e,o):o.length?h(e,o,s):"object"===a&&d(e,o,null,s)}}var c}function v(e){return e.nodeType&&e||!e.el&&e||v(e.el)}function g(e){return e&&e.nodeType}function E(e){for(var t,s=[],i=arguments.length-1;i-- >0;)s[i]=arguments[i+1];var n=typeof e;if("string"===n)t=function(e,t){var s=function(e){for(var t=e.split(/([.#])/),s="",i="",n=1;n<t.length;n+=2)switch(t[n]){case".":s+=" "+t[n+1];break;case"#":i=t[n+1]}return{className:s.trim(),tag:t[0]||"div",id:i}}(e),i=s.tag,n=s.id,r=s.className,o=t?document.createElementNS(t,i):document.createElement(i);return n&&(o.id=n),r&&(t?o.setAttribute("class",r):o.className=r),o}(e);else{if("function"!==n)throw new Error("At least one argument required");var r=e;t=new(Function.prototype.bind.apply(r,[null].concat(s)))}return h(v(t),s,!0),t}var f=E;E.extend=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return E.bind.apply(E,[this].concat(e))};var p={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};class m{constructor({firstScene:e,scenes:t,author:s,shortName:i,longName:n,description:r,language:o}){this.firstScene=e,this.scenes=t,this.shortName=i,this.longName=n,this.author=s,this.description=r,this.language=o}}var b,y={width:"100%",height:"100%"};!function(e){e.START="start",e.STOP="stop"}(b||(b={}));class _{constructor(e){this.index=0,this.events=e,this.queue=this.build(),this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const s={id:t,time:this.events[t].in,action:b.START},i={id:t,time:this.events[t].out,action:b.STOP};e.push(s,i)}return e}sort(e){if("desc"===e)this.queue.sort(((e,t)=>t.time-e.time));else this.queue.sort(((e,t)=>e.time-t.time))}}function T(e,t){let s=t-e;return void 0===e&&(e=0),s<=0&&(s=t,e=0),Math.floor(Math.random()*s)+e}class w{constructor(){this.registry={}}static tokenGenerator(e){const t=[];for(let s=0;s<e;s+=1){let e;do{e=T(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}broadcast(e,t){this.registry[e]?Object.values(this.registry[e]).forEach((e=>{e.handler.call(e.context,t)})):console.warn("Channel not registered:",e)}unRegister(e){const t=Object.keys(this.registry).filter((t=>Object.keys(this.registry[t]).includes(e)))[0];t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Unregister token not found")}register(e,t,s){const i=w.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][i]={handler:t,context:s},i}}const S=new w;var N,k;!function(e){e.PLAY="director:play",e.PAUSE="director:pause",e.SCENE_CHANGE="director:scenechange",e.SCENE_EVENT="director:sceneevent"}(N||(N={})),function(e){e.ENDED="video:ended",e.DURATION_CHANGED="video:durationchange",e.PAUSED="video:paused",e.PLAYING="video:playing",e.SEEKED="video:seeked",e.SEEKING="video:seeking",e.TIMEUPDATE="video:timeupdate"}(k||(k={}));class P extends Error{}class A{constructor({events:e,startEventCallback:t,stopEventCallback:s}){this.queue=new _(e),this.startEventCallback=t,this.stopEventCallback=s,this.radioUnregisterTokenTimeUpdate=S.register(k.TIMEUPDATE,this.isReadyToAction,this)}unRegister(){S.unRegister(this.radioUnregisterTokenTimeUpdate)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new P("Event data not found");switch(e.action){case b.START:this.startEventCallback(t);break;case b.STOP:this.stopEventCallback(t);break;default:return}this.queue.advance()}}class C{constructor(e){var t;this.events=(t={events:e,startEventCallback:this.start,stopEventCallback:this.stop},new A(t))}start({group:e,payload:t}){S.broadcast(N.SCENE_EVENT,{group:e,action:b.START,payload:t})}stop({group:e,payload:t}){S.broadcast(N.SCENE_EVENT,{group:e,action:b.STOP,payload:t})}unRegister(){this.events.unRegister()}}var U={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const D={height:"5px",width:"0px","background-color":"yellow"};class L{constructor(){this.el=f(".progressCounter",{style:Object.assign({},D)})}update(e=0,t){const s=e/t*100;o(this.el,{width:`${s}%`})}}class O{constructor(){this.duration=999,this.el=f("div",{style:Object.assign({},U)},this.progressCounter=new L),this.radioUnregisterTokenDurationChanged=S.register(k.DURATION_CHANGED,(e=>{this.duration=e})),this.radioUnregisterTokenTimeUpdate=S.register(k.TIMEUPDATE,this.updateProgress,this)}onunmount(){this.stopListeningToRadio()}stopListeningToRadio(){S.unRegister(this.radioUnregisterTokenDurationChanged),S.unRegister(this.radioUnregisterTokenTimeUpdate)}updateProgress(e){this.progressCounter.update(e,this.duration)}}var R,x;!function(e){e.MP4="mp4",e.OGG="ogg",e.WEBM="webm"}(R||(R={})),function(e){e.MP4="video/mp4",e.OGG="video/ogg",e.WEBM="video/webm"}(x||(x={}));class j extends Error{}class G{constructor(e,t){this.el=f("source",{src:t,type:this.mapFileExtensionToMIME_Type(e)})}mapFileExtensionToMIME_Type(e){switch(e){case R.MP4:return x.MP4;case R.OGG:return x.OGG;case R.WEBM:return x.WEBM;default:throw new j("Unable to process source in Video file")}}}var M={width:"100%",height:"100%","object-fit":"contain"};class I extends Error{}class q{constructor({controls:e=!1,loop:t=!1,muted:s=!1,sources:i}){this.el=f("video",{autoplay:!1,controls:e,loop:t,muted:s,style:Object.assign({},M)}),this.sources=this.setSources(i),this.mountSources(),this.broadcastEndedEvent=()=>S.broadcast(k.ENDED),this.broadcastDurationChangeEvent=()=>S.broadcast(k.DURATION_CHANGED,this.el.duration),this.broadcastPlayingEvent=()=>S.broadcast(k.PLAYING,this.el.currentTime),this.broadcastPausedEvent=()=>S.broadcast(k.PAUSED),this.broadcastSeekedEvent=()=>S.broadcast(k.SEEKED,this.el.currentTime),this.broadcastSeekingEvent=()=>S.broadcast(k.SEEKING,this.el.currentTime),this.broadcastTimeUpdateEvent=()=>S.broadcast(k.TIMEUPDATE,this.el.currentTime),this.radioUnregisterTokenPause=S.register(N.PAUSE,this.pause,this),this.radioUnregisterTokenPlay=S.register(N.PLAY,this.play,this),this.listenToVideoEvents()}onunmount(){this.stopListeningToVideoEvents(),this.stopListeningToRadio()}setSources(e){if(!e)throw new I("No video sources found");const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=new G(s,e[s]));return t}mountSources(){for(const e in this.sources){if(!this.sources.hasOwnProperty(e))continue;const t=this.sources[e];n(this.el,t.el)}}listenToVideoEvents(){this.el.addEventListener("ended",this.broadcastEndedEvent),this.el.addEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.addEventListener("paused",this.broadcastPausedEvent),this.el.addEventListener("playing",this.broadcastPlayingEvent),this.el.addEventListener("seeked",this.broadcastSeekedEvent),this.el.addEventListener("seeking",this.broadcastSeekingEvent),this.el.addEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToVideoEvents(){this.el.removeEventListener("ended",this.broadcastEndedEvent),this.el.removeEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.removeEventListener("paused",this.broadcastPausedEvent),this.el.removeEventListener("playing",this.broadcastPlayingEvent),this.el.removeEventListener("seeked",this.broadcastSeekedEvent),this.el.removeEventListener("seeking",this.broadcastSeekingEvent),this.el.removeEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToRadio(){S.unRegister(this.radioUnregisterTokenPause),S.unRegister(this.radioUnregisterTokenPlay)}play(){this.el.play().then((()=>{})).catch((()=>{}))}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}}class V{constructor(e,{events:t,longName:s,video:i}){S.broadcast(N.SCENE_CHANGE,e),this.el=f("div",{style:Object.assign({},y)},this.timeline=new O,this.video=new q(i)),this.sceneId=e,this.events=new C(t),this.longName=s,this.video.play()}onunmount(){this.events.unRegister()}}const H=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){S.register(k.DURATION_CHANGED,(e=>{this.currentDuration=e})),S.register(k.TIMEUPDATE,(e=>{this.currentTime=e}))}},$="0.7.3";return class{constructor(e,{width:t="100%",height:s="100%"}){this.version=$,this.v=$,this.story=null,this.scene=null,this.el=f("div",{style:Object.assign(Object.assign({},p),{width:`${t}`,height:`${s}`})}),n(e,this.el),this.setupSyntheticEvents()}setupSyntheticEvents(){S.register(N.SCENE_EVENT,(e=>{this.el.dispatchEvent(new CustomEvent(N.SCENE_EVENT,{detail:e}))}),this)}setStory(e){this.story=new m(e)}loadScene(t){var s,i,r,o;this.story&&(this.scene&&(s=this.el,i=this.scene,r=v(s),o=v(i),i===o&&o.__redom_view&&(i=o.__redom_view),o.parentNode&&(e(0,o,r),r.removeChild(o))),this.scene=new V(t,this.story.scenes[t]),n(this.el,this.scene))}currentDuration(){return H.currentDuration}currentTime(){return H.currentTime}startScript(e){try{return this.setStory(e),this.loadScene(e.firstScene),Promise.resolve()}catch(e){return Promise.reject(`Unable to load story object, ${e}`)}}pause(){S.broadcast(N.PAUSE)}play(){S.broadcast(N.PLAY)}reloadScene(){var e,t;(null===(e=this.scene)||void 0===e?void 0:e.sceneId)&&this.loadScene(null===(t=this.scene)||void 0===t?void 0:t.sceneId)}resize(e,t){o(this.el,{width:`${e}`,height:`${t}`})}skipTo(e){this.loadScene(e)}}}));
