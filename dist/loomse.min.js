"use strict";var e=require("redom"),t={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};class s{constructor({firstScene:e,scenes:t,author:s,shortName:i,longName:n,description:r,language:o}){this.firstScene=e,this.scenes=t,this.shortName=i,this.longName=n,this.author=s,this.description=r,this.language=o}}var i,n={width:"100%",height:"100%"};!function(e){e.START="start",e.STOP="stop"}(i||(i={}));class r{constructor(e){this.index=0,this.events=e,this.queue=this.build(),this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const s={id:t,time:this.events[t].in,action:i.START},n={id:t,time:this.events[t].out,action:i.STOP};e.push(s,n)}return e}sort(e){if("desc"===e)this.queue.sort(((e,t)=>t.time-e.time));else this.queue.sort(((e,t)=>e.time-t.time))}}function o(e,t){let s=t-e;return void 0===e&&(e=0),s<=0&&(s=t,e=0),Math.floor(Math.random()*s)+e}class a{constructor(){this.registry={}}static tokenGenerator(e){const t=[];for(let s=0;s<e;s+=1){let e;do{e=o(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}broadcast(e,t){this.registry[e]?Object.values(this.registry[e]).forEach((e=>{e.handler.call(e.context,t)})):console.warn("Channel not registered:",e)}unRegister(e){const t=Object.keys(this.registry).filter((t=>Object.keys(this.registry[t]).includes(e)))[0];t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Unregister token not found")}register(e,t,s){const i=a.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][i]={handler:t,context:s},i}}const h=new a;var c,d;!function(e){e.PLAY="director:play",e.PAUSE="director:pause",e.SCENE_CHANGE="director:scenechange",e.SCENE_EVENT="director:sceneevent"}(c||(c={})),function(e){e.ENDED="video:ended",e.DURATION_CHANGED="video:durationchange",e.PAUSED="video:paused",e.PLAYING="video:playing",e.SEEKED="video:seeked",e.SEEKING="video:seeking",e.TIMEUPDATE="video:timeupdate"}(d||(d={}));class u extends Error{}class l{constructor({events:e,startEventCallback:t,stopEventCallback:s}){this.queue=new r(e),this.startEventCallback=t,this.stopEventCallback=s,this.radioUnregisterTokenTimeUpdate=h.register(d.TIMEUPDATE,this.isReadyToAction,this)}unRegister(){h.unRegister(this.radioUnregisterTokenTimeUpdate)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new u("Event data not found");switch(e.action){case i.START:this.startEventCallback(t);break;case i.STOP:this.stopEventCallback(t);break;default:return}this.queue.advance()}}class E{constructor(e){var t;this.events=(t={events:e,startEventCallback:this.start,stopEventCallback:this.stop},new l(t))}start({group:e,payload:t}){h.broadcast(c.SCENE_EVENT,{group:e,action:i.START,payload:t})}stop({group:e,payload:t}){h.broadcast(c.SCENE_EVENT,{group:e,action:i.STOP,payload:t})}unRegister(){this.events.unRegister()}}var g={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const v={height:"5px",width:"0px","background-color":"yellow"};class p{constructor(){this.el=e.el(".progressCounter",{style:Object.assign({},v)})}update(t=0,s){const i=t/s*100;e.setStyle(this.el,{width:`${i}%`})}}class T{constructor(){this.duration=999,this.el=e.el("",{style:Object.assign({},g)},this.progressCounter=new p),this.radioUnregisterTokenDurationChanged=h.register(d.DURATION_CHANGED,(e=>{this.duration=e})),this.radioUnregisterTokenTimeUpdate=h.register(d.TIMEUPDATE,this.updateProgress,this)}onunmount(){this.stopListeningToRadio()}stopListeningToRadio(){h.unRegister(this.radioUnregisterTokenDurationChanged),h.unRegister(this.radioUnregisterTokenTimeUpdate)}updateProgress(e){this.progressCounter.update(e,this.duration)}}var b,m;!function(e){e.MP4="mp4",e.OGG="ogg",e.WEBM="webm"}(b||(b={})),function(e){e.MP4="video/mp4",e.OGG="video/ogg",e.WEBM="video/webm"}(m||(m={}));class y extends Error{}class S{constructor(t,s){this.el=e.el("source",{src:s,type:this.mapFileExtensionToMIME_Type(t)})}mapFileExtensionToMIME_Type(e){switch(e){case b.MP4:return m.MP4;case b.OGG:return m.OGG;case b.WEBM:return m.WEBM;default:throw new y("Unable to process source in Video file")}}}var k={width:"100%",height:"100%","object-fit":"contain"};class P extends Error{}class w{constructor({controls:t=!1,loop:s=!1,muted:i=!1,sources:n}){this.el=e.el("video",{autoplay:!1,controls:t,loop:s,muted:i,style:Object.assign({},k)}),this.sources=this.setSources(n),this.mountSources(),this.broadcastEndedEvent=()=>h.broadcast(d.ENDED),this.broadcastDurationChangeEvent=()=>h.broadcast(d.DURATION_CHANGED,this.el.duration),this.broadcastPlayingEvent=()=>h.broadcast(d.PLAYING,this.el.currentTime),this.broadcastPausedEvent=()=>h.broadcast(d.PAUSED),this.broadcastSeekedEvent=()=>h.broadcast(d.SEEKED,this.el.currentTime),this.broadcastSeekingEvent=()=>h.broadcast(d.SEEKING,this.el.currentTime),this.broadcastTimeUpdateEvent=()=>h.broadcast(d.TIMEUPDATE,this.el.currentTime),this.radioUnregisterTokenPause=h.register(c.PAUSE,this.pause,this),this.radioUnregisterTokenPlay=h.register(c.PLAY,this.play,this),this.listenToVideoEvents()}onunmount(){this.stopListeningToVideoEvents(),this.stopListeningToRadio()}setSources(e){if(!e)throw new P("No video sources found");const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=new S(s,e[s]));return t}mountSources(){for(const t in this.sources){if(!this.sources.hasOwnProperty(t))continue;const s=this.sources[t];e.mount(this.el,s.el)}}listenToVideoEvents(){this.el.addEventListener("ended",this.broadcastEndedEvent),this.el.addEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.addEventListener("paused",this.broadcastPausedEvent),this.el.addEventListener("playing",this.broadcastPlayingEvent),this.el.addEventListener("seeked",this.broadcastSeekedEvent),this.el.addEventListener("seeking",this.broadcastSeekingEvent),this.el.addEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToVideoEvents(){this.el.removeEventListener("ended",this.broadcastEndedEvent),this.el.removeEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.removeEventListener("paused",this.broadcastPausedEvent),this.el.removeEventListener("playing",this.broadcastPlayingEvent),this.el.removeEventListener("seeked",this.broadcastSeekedEvent),this.el.removeEventListener("seeking",this.broadcastSeekingEvent),this.el.removeEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToRadio(){h.unRegister(this.radioUnregisterTokenPause),h.unRegister(this.radioUnregisterTokenPlay)}play(){this.el.play().then((()=>{})).catch((()=>{}))}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}}class f{constructor(t,{events:s,longName:i,video:r}){h.broadcast(c.SCENE_CHANGE,t),this.el=e.el("",{style:Object.assign({},n)},this.timeline=new T,this.video=new w(r)),this.sceneId=t,this.events=new E(s),this.longName=i,this.video.play()}onunmount(){this.events.unRegister()}}const N=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){h.register(d.DURATION_CHANGED,(e=>{this.currentDuration=e})),h.register(d.TIMEUPDATE,(e=>{this.currentTime=e}))}},U="0.7.2";module.exports=class{constructor(s,{width:i="100%",height:n="100%"}){this.story=null,this.scene=null,this.version=U,this.v=U,this.el=e.el("",{style:Object.assign(Object.assign({},t),{width:`${i}`,height:`${n}`})}),e.mount(s,this.el),this.setupSyntheticEvents()}setupSyntheticEvents(){h.register(c.SCENE_EVENT,(e=>{this.el.dispatchEvent(new CustomEvent(c.SCENE_EVENT,{detail:e}))}),this)}setStory(e){this.story=new s(e)}loadScene(t){this.story&&(this.scene&&e.unmount(this.el,this.scene),this.scene=new f(t,this.story.scenes[t]),e.mount(this.el,this.scene))}currentDuration(){return N.currentDuration}currentTime(){return N.currentTime}startScript(e){try{return this.setStory(e),this.loadScene(e.firstScene),Promise.resolve()}catch(e){return Promise.reject(`Unable to load story object, ${e}`)}}pause(){h.broadcast(c.PAUSE)}play(){h.broadcast(c.PLAY)}reloadScene(){var e,t;(null===(e=this.scene)||void 0===e?void 0:e.sceneId)&&this.loadScene(null===(t=this.scene)||void 0===t?void 0:t.sceneId)}resize(t,s){e.setStyle(this.el,{width:`${t}`,height:`${s}`})}skipTo(e){this.loadScene(e)}};
