"use strict";var e=require("redom");function t(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function s(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function i(e){for(var i=1;i<arguments.length;i++){var r=null!=arguments[i]?arguments[i]:{};i%2?s(Object(r),!0).forEach((function(s){t(e,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var r={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};class n{constructor(e){let{shortName:t,longName:s,author:i,description:r,firstScene:n,language:o,scenes:a}=e;this.shortName=t,this.longName=s,this.author=i,this.description=r,this.firstScene=n,this.scenes=a,this.language=o}}var o={width:"100%",height:"100%"};class a{constructor(e){this.events=e,this.queue=this.build(),this.index=0,this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const s={id:t,time:this.events[t].in,action:"start"},i={id:t,time:this.events[t].out,action:"stop"};e.push(s,i)}return e}sort(e){switch(e){case"desc":this.queue.sort(((e,t)=>t.time-e.time));break;case"asc":default:this.queue.sort(((e,t)=>e.time-t.time))}}}class c extends Error{}class h{constructor(e){let{events:t,startEventCallback:s,stopEventCallback:i}=e;this.queue=new a(t),this.startEventCallback=s,this.stopEventCallback=i,this.tokenTimeUpdate=u.register("video:timeupdate",this.isReadyToAction,this)}unRegister(){u.unRegister(this.tokenTimeUpdate)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new c("Event data not found");switch(e.action){case"start":this.startEventCallback(t);break;case"stop":this.stopEventCallback(t);break;default:return}this.queue.advance()}}function d(e,t){let s=t-e;return void 0===e&&(e=0),s<=0&&(s=t,e=0),Math.floor(Math.random()*s)+e}const u=new class{static tokenGenerator(e){if("number"!=typeof e)throw new Error("Length not a number");const t=[];for(let s=0;s<e;s+=1){let e;do{e=d(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}constructor(){this.registry={}}broadcast(e,t){this.registry[e]?Object.values(this.registry[e]).forEach((e=>{e.handler.call(e.context,t)})):console.warn("Channel not registered:",e)}unRegister(e){const t=Object.keys(this.registry).filter((t=>Object.keys(this.registry[t]).includes(e)));t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Token not found")}register(e,t,s){const i=this.constructor.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][i]={handler:t,context:s},i}};class l{constructor(e){var t;this.events=(t={events:e,startEventCallback:this.start,stopEventCallback:this.stop},new h(t))}start(e){let{group:t,payload:s}=e;u.broadcast("director:sceneevent",{group:t,action:"start",payload:s})}stop(e){let{group:t,payload:s}=e;u.broadcast("director:sceneevent",{group:t,action:"stop",payload:s})}unRegister(){this.events.unRegister()}}var p={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const g={height:"5px",width:"0px","background-color":"yellow"};class v{constructor(){this.el=e.el(".progressCounter",{style:i({},g)})}update(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)/(arguments.length>1?arguments[1]:void 0)*100;e.setStyle(this.el,{width:"".concat(t,"%")})}}class b{constructor(){this.el=e.el("",{style:i({},p)},this.progressCounter=new v),this.duration=999,this.tokenDurationChanged=u.register("video:durationchange",(e=>{this.duration=e})),this.tokenTimeUpdate=u.register("video:timeupdate",this.updateProgress,this)}onunmount(){this.stopListeningToRadio()}stopListeningToRadio(){u.unRegister(this.tokenDurationChanged),u.unRegister(this.tokenTimeUpdate)}updateProgress(e){this.progressCounter.update(e,this.duration)}}class m extends Error{}class y{constructor(t,s){this.el=e.el("source",{src:s,type:this.mapFileFormatToMediaType(t)})}mapFileFormatToMediaType(e){switch(e){case"mp4":return"video/mp4";case"ogg":return"video/ogg";case"webm":return"video/webm";default:throw new m("Unable to process source in Video file")}}}var E={width:"100%",height:"100%","object-fit":"contain"};class f extends Error{}class w{constructor(t){let{controls:s=!1,loop:r=!1,muted:n=!1,sources:o={}}=t;this.el=e.el("video",{autoplay:!1,controls:s,loop:r,muted:n,style:i({},E)}),this.sources=this.setSources(o),this.mountSources(),this.broadcastEndedEvent=()=>u.broadcast("video:ended"),this.broadcastDurationChangeEvent=()=>u.broadcast("video:durationchange",this.el.duration),this.broadcastPlayingEvent=()=>u.broadcast("video:playing",this.el.currentTime),this.broadcastPausedEvent=()=>u.broadcast("video:paused"),this.broadcastSeekedEvent=()=>u.broadcast("video:seeked",this.el.currentTime),this.broadcastSeekingEvent=()=>u.broadcast("video:seeking",this.el.currentTime),this.broadcastTimeUpdateEvent=()=>u.broadcast("video:timeupdate",this.el.currentTime),this.tokenPause=u.register("director:pause",this.pause,this),this.tokenPlay=u.register("director:play",this.play,this),this.listenToVideoEvents()}onunmount(){this.stopListeningToVideoEvents(),this.stopListeningToRadio()}setSources(e){if(!e)throw new f("No video sources found");const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=new y(s,e[s]));return t}mountSources(){for(const t in this.sources){if(!this.sources.hasOwnProperty(t))continue;const s=this.sources[t];e.mount(this.el,s.el)}}listenToVideoEvents(){this.el.addEventListener("ended",this.broadcastEndedEvent),this.el.addEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.addEventListener("paused",this.broadcastPausedEvent),this.el.addEventListener("playing",this.broadcastPlayingEvent),this.el.addEventListener("seeked",this.broadcastSeekedEvent),this.el.addEventListener("seeking",this.broadcastSeekingEvent),this.el.addEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToVideoEvents(){this.el.removeEventListener("ended",this.broadcastEndedEvent),this.el.removeEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.removeEventListener("paused",this.broadcastPausedEvent),this.el.removeEventListener("playing",this.broadcastPlayingEvent),this.el.removeEventListener("seeked",this.broadcastSeekedEvent),this.el.removeEventListener("seeking",this.broadcastSeekingEvent),this.el.removeEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToRadio(){u.unRegister(this.tokenPause),u.unRegister(this.tokenPlay)}play(){this.el.play().then((()=>{})).catch((()=>{}))}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}}class k{constructor(t,s){let{events:r,longName:n,video:a}=s;u.broadcast("director:scenechange",t),this.el=e.el("",{style:i({},o)},this.timeline=new b,this.video=new w(a)),this.events=new l(r),this.longName=n,this.video.play()}onunmount(){this.events.unRegister()}}new class{constructor(){this.currentScene="",this.registerListeners()}registerListeners(){u.register("director:scenechange",(e=>{this.currentScene=e}))}};const T=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){u.register("video:durationchange",(e=>{this.currentDuration=e})),u.register("video:timeupdate",(e=>{this.currentTime=e}))}};class S{constructor(t){let{width:s="100%",height:n="100%"}=t;this.el=e.el("",{style:i(i({},r),{},{width:"".concat(s),height:"".concat(n)})}),this.story={},this.scene=null,this.setupSyntheticEvents()}currentDuration(){return T.currentDuration}currentTime(){return T.currentTime}setStory(e){this.story=new n(e)}loadScene(t){this.scene&&e.unmount(this.el,this.scene),this.scene=new k(t,this.story.scenes[t]),e.mount(this.el,this.scene)}pause(){u.broadcast("director:pause")}play(){u.broadcast("director:play")}resize(t,s){e.setStyle(this.el,{width:"".concat(t),height:"".concat(s)})}setupSyntheticEvents(){u.register("director:sceneevent",(e=>{this.el.dispatchEvent(new CustomEvent("director:sceneevent",{detail:e}))}),this)}}var P="0.6.6";module.exports=function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=P,r=new S(s);return e.mount(t,r),{currentDuration:()=>r.currentDuration(),currentTime:()=>r.currentTime(),el:r.el,startScript(e){try{return r.setStory(e),r.loadScene(r.story.firstScene),Promise.resolve()}catch(e){return Promise.reject("Unable to load story object, ".concat(e))}},pause(){r.pause()},play(){r.play()},reloadScene(){r.loadScene()},resize(e,t){r.resize(e,t)},skipTo(e){r.loadScene(e)},version:i,v:i}};
