!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).LoomSE=t()}(this,(function(){"use strict";function e(e,n,s){var i=n.__redom_lifecycle;if(t(i))n.__redom_lifecycle={};else{var o=s;for(n.__redom_mounted&&r(n,"onunmount");o;){var a=o.__redom_lifecycle||{};for(var c in i)a[c]&&(a[c]-=i[c]);t(a)&&(o.__redom_lifecycle=null),o=o.parentNode}}}function t(e){if(null==e)return!0;for(var t in e)if(e[t])return!1;return!0}var n=["onmount","onremount","onunmount"],s="undefined"!=typeof window&&"ShadowRoot"in window;function i(t,i,o,a){var c=p(t),u=p(i);i===u&&u.__redom_view&&(i=u.__redom_view),i!==u&&(u.__redom_view=i);var l=u.__redom_mounted,d=u.parentNode;if(l&&d!==c&&e(0,u,d),null!=o)if(a){var h=p(o);h.__redom_mounted&&r(h,"onunmount"),c.replaceChild(u,h)}else c.insertBefore(u,p(o));else c.appendChild(u);return function(e,t,i,o){for(var a=t.__redom_lifecycle||(t.__redom_lifecycle={}),c=i===o,u=!1,l=0,d=n;l<d.length;l+=1){var h=d[l];c||e!==t&&h in e&&(a[h]=(a[h]||0)+1),a[h]&&(u=!0)}if(!u)return void(t.__redom_lifecycle={});var p=i,v=!1;(c||p&&p.__redom_mounted)&&(r(t,c?"onremount":"onmount"),v=!0);for(;p;){var f=p.parentNode,m=p.__redom_lifecycle||(p.__redom_lifecycle={});for(var E in a)m[E]=(m[E]||0)+a[E];if(v)break;(p.nodeType===Node.DOCUMENT_NODE||s&&p instanceof ShadowRoot||f&&f.__redom_mounted)&&(r(p,c?"onremount":"onmount"),v=!0),p=f}}(i,u,c,d),i}function r(e,t){"onmount"===t||"onremount"===t?e.__redom_mounted=!0:"onunmount"===t&&(e.__redom_mounted=!1);var n=e.__redom_lifecycle;if(n){var s=e.__redom_view,i=0;for(var o in s&&s[t]&&s[t](),n)o&&i++;if(i)for(var a=e.firstChild;a;){var c=a.nextSibling;r(a,t),a=c}}}function o(e,t,n){var s=p(e);if("object"==typeof t)for(var i in t)a(s,i,t[i]);else a(s,t,n)}function a(e,t,n){e.style[t]=null==n?"":n}var c="http://www.w3.org/1999/xlink";function u(e,t,n,s){var i=p(e);if("object"==typeof t)for(var r in t)u(i,r,t[r],s);else{var a=i instanceof SVGElement,c="function"==typeof n;if("style"===t&&"object"==typeof n)o(i,n);else if(a&&c)i[t]=n;else if("dataset"===t)d(i,n);else if(a||!(t in i)&&!c||"list"===t){if(a&&"xlink"===t)return void l(i,n);s&&"class"===t&&(n=i.className+" "+n),null==n?i.removeAttribute(t):i.setAttribute(t,n)}else i[t]=n}}function l(e,t,n){if("object"==typeof t)for(var s in t)l(e,s,t[s]);else null!=n?e.setAttributeNS(c,t,n):e.removeAttributeNS(c,t,n)}function d(e,t,n){if("object"==typeof t)for(var s in t)d(e,s,t[s]);else null!=n?e.dataset[t]=n:delete e.dataset[t]}function h(e,t,n){for(var s=0,r=t;s<r.length;s+=1){var o=r[s];if(0===o||o){var a=typeof o;"function"===a?o(e):"string"===a||"number"===a?e.appendChild((c=o,document.createTextNode(null!=c?c:""))):v(p(o))?i(e,o):o.length?h(e,o,n):"object"===a&&u(e,o,null,n)}}var c}function p(e){return e.nodeType&&e||!e.el&&e||p(e.el)}function v(e){return e&&e.nodeType}function f(e){for(var t,n=[],s=arguments.length-1;s-- >0;)n[s]=arguments[s+1];var i=typeof e;if("string"===i)t=function(e,t){var n=function(e){for(var t=e.split(/([.#])/),n="",s="",i=1;i<t.length;i+=2)switch(t[i]){case".":n+=" "+t[i+1];break;case"#":s=t[i+1]}return{className:n.trim(),tag:t[0]||"div",id:s}}(e),s=n.tag,i=n.id,r=n.className,o=t?document.createElementNS(t,s):document.createElement(s);return i&&(o.id=i),r&&(t?o.setAttribute("class",r):o.className=r),o}(e);else{if("function"!==i)throw new Error("At least one argument required");var r=e;t=new(Function.prototype.bind.apply(r,[null].concat(n)))}return h(p(t),n,!0),t}var m=f;f.extend=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return f.bind.apply(f,[this].concat(e))};var E={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};class T{constructor({firstScene:e,scenes:t,author:n,shortName:s,longName:i,description:r,language:o}){this.firstScene=e,this.scenes=t,this.shortName=s,this.longName=i,this.author=n,this.description=r,this.language=o}}var y={width:"100%",height:"100%"};function _(e,t){let n=t-e;return void 0===e&&(e=0),n<=0&&(n=t,e=0),Math.floor(Math.random()*n)+e}class g{constructor(){this.registry={}}static tokenGenerator(e){const t=[];for(let n=0;n<e;n+=1){let e;do{e=_(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}broadcastOnChannel(e,t){this.registry[e]?Object.values(this.registry[e]).forEach((e=>{e.handler.call(e.context,t)})):console.warn(`Channel ${e} has no listeners`)}listenToChannel(e,t,n){const s=g.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][s]={handler:t,context:n},s}stopListening(e){const t=Object.keys(this.registry).filter((t=>Object.keys(this.registry[t]).includes(e)))[0];t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Listener token not found")}}const b=new g;var C,S;!function(e){e.START="start",e.STOP="stop"}(C||(C={}));class w{constructor(e){this.index=0,this.events=e,this.queue=this.build(),this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const n={id:t,time:this.events[t].in,action:C.START},s={id:t,time:this.events[t].out,action:C.STOP};e.push(n,s)}return e}sort(e){if("desc"===e)this.queue.sort(((e,t)=>t.time-e.time));else this.queue.sort(((e,t)=>e.time-t.time))}}!function(e){e.DIRECTOR_PLAY="director:play",e.DIRECTOR_PAUSE="director:pause",e.DIRECTOR_SCENE_CHANGE="director:scenechange",e.DIRECTOR_SCENE_EVENT="director:sceneevent",e.VIDEO_ENDED="video:ended",e.VIDEO_DURATION_CHANGED="video:durationchange",e.VIDEO_PAUSED="video:paused",e.VIDEO_PLAYING="video:playing",e.VIDEO_SEEKED="video:seeked",e.VIDEO_SEEKING="video:seeking",e.VIDEO_TIMEUPDATE="video:timeupdate",e.SUBTITLE_POST="subtitle:post",e.SUBTITLE_CLEAR="subtitle:clear"}(S||(S={}));const O=e=>b.listenToChannel(S.VIDEO_DURATION_CHANGED,e),k=e=>b.listenToChannel(S.VIDEO_TIMEUPDATE,e);class D extends Error{}class A{constructor({events:e,startEventCallback:t,stopEventCallback:n}){this.queue=new w(e),this.startEventCallback=t,this.stopEventCallback=n,this.listenerToken=k((e=>this.isReadyToAction(e)))}stopListeningToRadio(){b.stopListening(this.listenerToken)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new D("Event data not found");switch(e.action){case C.START:this.startEventCallback(t);break;case C.STOP:this.stopEventCallback(t);break;default:return}this.queue.advance()}}const N=e=>new A(e),L=e=>b.broadcastOnChannel(S.DIRECTOR_SCENE_EVENT,{action:e.action,message:e.payload});class I{constructor(e){this.events=N({events:e,startEventCallback:this.start,stopEventCallback:this.stop})}start({payload:e}){L({action:C.START,payload:e})}stop({payload:e}){L({action:C.STOP,payload:e})}stopListeningToRadio(){this.events.stopListeningToRadio()}}var R={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const P={height:"5px",width:"0px","background-color":"yellow"};class x{constructor(){this.el=m(".progressCounter",{style:Object.assign({},P)})}update(e=0,t){const n=e/t*100;o(this.el,{width:`${n}%`})}}class V{constructor(){this.duration=999,this.el=m("div",{style:Object.assign({},R)},this.progressCounter=new x),this.tokenDurationChanged=O((e=>{this.duration=e})),this.tokenTimeUpdate=k((e=>this.updateProgress(e)))}onunmount(){this.stopListeningToRadio()}stopListeningToRadio(){b.stopListening(this.tokenDurationChanged),b.stopListening(this.tokenTimeUpdate)}updateProgress(e){this.progressCounter.update(e,this.duration)}}var U,j;!function(e){e.MP4="mp4",e.OGG="ogg",e.WEBM="webm"}(U||(U={})),function(e){e.MP4="video/mp4",e.OGG="video/ogg",e.WEBM="video/webm"}(j||(j={}));class M extends Error{}class B{constructor(e,t){this.el=m("source",{src:t,type:this.mapFileExtensionToMIME_Type(e)})}mapFileExtensionToMIME_Type(e){switch(e){case U.MP4:return j.MP4;case U.OGG:return j.OGG;case U.WEBM:return j.WEBM;default:throw new M("Unable to process source in Video file")}}}var G={width:"100%",height:"100%","object-fit":"contain"},q=function(e,t){return q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},q(e,t)};function W(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}q(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}"function"==typeof SuppressedError&&SuppressedError;var $=function(e){var t=e.hours,n=void 0===t?0:t,s=e.minutes,i=void 0===s?0:s,r=e.seconds,o=void 0===r?0:r,a=e.milliseconds,c=1e3;return 60*n*60*c+60*i*c+o*c+(void 0===a?0:a)},Y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return W(t,e),t}(Error),H=function(){function e(){}return e.parseTimeStamps=function(t,n){var s=t.split(n),i=s[0],r=s[1];if(r){var o=e.splitTimeStamp(i),a=e.splitTimeStamp(r);return{startTime:$(o),endTime:$(a)}}},e.splitTimeStamp=function(e){var t=e.split(":"),n=t[0],s=t[1],i=t[2],r=i.includes(",")?",":i.includes(".")?".":"";if(""===r)throw new Y("Unable to process timestamp");var o=i.split(r),a=o[0],c=o[1];return{hours:Number(n),minutes:Number(s),seconds:Number(a),milliseconds:Number(c)}},e}(),K=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return W(t,e),t}(Error),F=function(){function e(){}return e.processStringToArray=function(e){return e.split("\n")},e.processArrayToArrayBlocks=function(e){return e.reduce((function(e,t){return""===t?e.push([]):e[e.length-1].push(t),e}),[[]])},e.dropEmptyArrayBlocks=function(e){return e.filter((function(e){return e.length}))},e.processArrayBlocksToCues=function(e,t){return e.map((function(e,n){var s=e.reduce((function(e,n,s){if(0===s&&!n.includes(t))return e;if(!e.endTime&&n.includes(t)){var i=H.parseTimeStamps(n,t);return i&&(e.startTime=i.startTime,e.endTime=i.endTime),e}return e.text.push(n),e}),{sequence:n,startTime:0,endTime:0,text:[]});if(s.endTime<=s.startTime)throw new K("Invalid Cue: Timecodes not valid");return s}))},e}(),z=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.timeStampMarker="--\x3e",t}return W(t,e),t.prototype.parse=function(e){var t=F.processStringToArray(e),n=F.processArrayToArrayBlocks(t),s=F.dropEmptyArrayBlocks(n);return F.processArrayBlocksToCues(s,this.timeStampMarker)},t}(F),J=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.timeStampMarker="--\x3e",t}return W(t,e),t.prototype.parse=function(e){var t=F.processStringToArray(e),n=F.processArrayToArrayBlocks(t),s=F.dropEmptyArrayBlocks(n),i=this.dropNonCueData(s);return F.processArrayBlocksToCues(i,this.timeStampMarker)},t.prototype.dropNonCueData=function(e){return e.filter((function(e){var t=e[0];return!(t.startsWith("WEBVTT")||t.startsWith("NOTE")||t.startsWith("STYLE"))}))},t}(F);
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */
function Q(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))}class X{static mapCueToScriptedEvent(e){return e.map((e=>({in:e.startTime,out:e.endTime,payload:e.text})))}constructor(e){this.cues=null,this.fileContents=null,this.eventService=null,this.filePath=e,this.format=function(e){var t,n=e.toLowerCase().split("."),s=n[n.length-1];switch(s){case"srt":t="SRT";break;case"vtt":t="WEBVTT";break;default:t="Unsupported"}return{extension:s,format:t}}(e).format,function(e){return Q(this,void 0,void 0,(function*(){return(yield fetch(e)).text()}))}(e).then((e=>{this.fileContents=e,function(e,t){return new Promise((function(n,s){var i="WEBVTT"===e?new J:new z;try{n(i.parse(t))}catch(e){s(e)}}))}(this.format,e).then((e=>{this.cues=e,this.eventService=N({events:X.mapCueToScriptedEvent(e),startEventCallback:this.post,stopEventCallback:this.clear})}))})).catch((e=>{this.fileContents=null,console.warn("Unable to activate subtitles"),console.warn(e)}))}post({payload:e}){var t;t=e,b.broadcastOnChannel(S.SUBTITLE_POST,t)}clear(){b.broadcastOnChannel(S.SUBTITLE_CLEAR)}stopListeningToRadio(){this.eventService&&this.eventService.stopListeningToRadio()}}class Z extends Error{}class ee{constructor({controls:e=!1,loop:t=!1,muted:n=!1,sources:s,subtitles:i}){var r;this.el=m("video",{autoplay:!1,controls:e,loop:t,muted:n,style:Object.assign({},G)}),this.sources=this.setSources(s),this.mountSources(),i&&new X(i),this.broadcastEndedEvent=()=>b.broadcastOnChannel(S.VIDEO_ENDED),this.broadcastDurationChangeEvent=()=>{return e=this.el.duration,b.broadcastOnChannel(S.VIDEO_DURATION_CHANGED,e);var e},this.broadcastPlayingEvent=()=>{return e=this.el.currentTime,b.broadcastOnChannel(S.VIDEO_PLAYING,e);var e},this.broadcastPausedEvent=()=>b.broadcastOnChannel(S.VIDEO_PAUSED),this.broadcastSeekedEvent=()=>{return e=this.el.currentTime,b.broadcastOnChannel(S.VIDEO_SEEKED,e);var e},this.broadcastSeekingEvent=()=>{return e=this.el.currentTime,b.broadcastOnChannel(S.VIDEO_SEEKING,e);var e},this.broadcastTimeUpdateEvent=()=>{return e=this.el.currentTime,b.broadcastOnChannel(S.VIDEO_TIMEUPDATE,e);var e},this.tokenPause=(r=()=>this.pause,b.listenToChannel(S.DIRECTOR_PAUSE,r)),this.tokenPlay=(e=>b.listenToChannel(S.DIRECTOR_PLAY,e))((()=>this.play)),this.listenToVideoEvents()}onunmount(){this.stopListeningToVideoEvents(),this.stopListeningToRadio()}setSources(e){if(!e)throw new Z("No video sources found");const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=new B(n,e[n]));return t}mountSources(){for(const e in this.sources){if(!this.sources.hasOwnProperty(e))continue;const t=this.sources[e];i(this.el,t.el)}}listenToVideoEvents(){this.el.addEventListener("ended",this.broadcastEndedEvent),this.el.addEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.addEventListener("paused",this.broadcastPausedEvent),this.el.addEventListener("playing",this.broadcastPlayingEvent),this.el.addEventListener("seeked",this.broadcastSeekedEvent),this.el.addEventListener("seeking",this.broadcastSeekingEvent),this.el.addEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToVideoEvents(){this.el.removeEventListener("ended",this.broadcastEndedEvent),this.el.removeEventListener("durationchange",this.broadcastDurationChangeEvent),this.el.removeEventListener("paused",this.broadcastPausedEvent),this.el.removeEventListener("playing",this.broadcastPlayingEvent),this.el.removeEventListener("seeked",this.broadcastSeekedEvent),this.el.removeEventListener("seeking",this.broadcastSeekingEvent),this.el.removeEventListener("timeupdate",this.broadcastTimeUpdateEvent)}stopListeningToRadio(){b.stopListening(this.tokenPause),b.stopListening(this.tokenPlay)}play(){this.el.play().catch((e=>{console.warn(e)}))}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}}class te{constructor(e,{events:t,longName:n,video:s}){(e=>{b.broadcastOnChannel(S.DIRECTOR_SCENE_CHANGE,e)})(e),this.el=m("div",{style:Object.assign({},y)},this.timeline=new V,this.video=new ee(s)),this.sceneId=e,this.events=new I(t),this.longName=n,this.video.play()}onunmount(){this.events.stopListeningToRadio()}}const ne=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){O((e=>{this.currentDuration=e})),k((e=>{this.currentTime=e}))}},se="0.8.0";return class{constructor(e,{width:t="100%",height:n="100%"}){this.version=se,this.v=se,this.story=null,this.scene=null,this.el=m("div",{style:Object.assign(Object.assign({},E),{width:`${t}`,height:`${n}`})}),i(e,this.el),this.setupSyntheticEvents()}setupSyntheticEvents(){var e;e=e=>{this.el.dispatchEvent(new CustomEvent(S.DIRECTOR_SCENE_EVENT,{detail:e}))},b.listenToChannel(S.DIRECTOR_SCENE_EVENT,e)}setStory(e){this.story=new T(e)}loadScene(t){var n,s,r,o;this.story&&(this.scene&&(n=this.el,s=this.scene,r=p(n),o=p(s),s===o&&o.__redom_view&&(s=o.__redom_view),o.parentNode&&(e(0,o,r),r.removeChild(o))),this.scene=new te(t,this.story.scenes[t]),i(this.el,this.scene))}currentDuration(){return ne.currentDuration}currentTime(){return ne.currentTime}startScript(e){try{return this.setStory(e),this.loadScene(e.firstScene),Promise.resolve()}catch(e){return Promise.reject(`Unable to load story object, ${e}`)}}pause(){b.broadcastOnChannel(S.DIRECTOR_PAUSE)}play(){b.broadcastOnChannel(S.DIRECTOR_PLAY)}reloadScene(){var e,t;(null===(e=this.scene)||void 0===e?void 0:e.sceneId)&&this.loadScene(null===(t=this.scene)||void 0===t?void 0:t.sceneId)}resize(e,t){o(this.el,{width:`${e}`,height:`${t}`})}skipTo(e){this.loadScene(e)}}}));
